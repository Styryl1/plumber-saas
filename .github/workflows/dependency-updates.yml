name: 🔄 Automated Dependency Updates

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM
  workflow_dispatch:     # Manual trigger

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  safe-updates:
    name: Safe Patch Updates
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🚀 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Install Dependencies
        run: |
          npm ci
          npm install -g npm-check-updates
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/test"
          DIRECT_URL: "postgresql://test:test@localhost:5432/test"

      - name: 🔍 Check for Safe Updates
        id: updates
        run: |
          npm run update-safe
          echo "changes=$(git status --porcelain)" >> $GITHUB_OUTPUT

      - name: 🧪 Test After Updates
        if: steps.updates.outputs.changes
        run: |
          npm install
          npm run test-after-update
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/test"
          DIRECT_URL: "postgresql://test:test@localhost:5432/test"

      - name: 📝 Create Pull Request
        if: steps.updates.outputs.changes
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "🔄 Automated safe dependency updates"
          title: "🔄 Safe dependency updates (patch versions)"
          body: |
            ## 🔄 Automated Dependency Updates
            
            This PR contains safe patch-level updates that have been automatically tested.
            
            ### ✅ What's Updated:
            - Patch versions (x.x.X) only
            - Security patches included
            - All tests pass
            
            ### 🧪 Automated Testing:
            - ✅ ESLint validation
            - ✅ TypeScript compilation 
            - ✅ Production build test
            
            ### 🚀 Safe to Merge:
            These updates contain only bug fixes and security patches with minimal breaking change risk.
            
            🤖 Generated by Plumber SaaS automation
          branch: automated/safe-updates
          delete-branch: true
          labels: |
            dependencies
            automated
            safe-update

  security-alerts:
    name: Security Vulnerability Check
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🚀 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Install Dependencies (Security Job)
        run: |
          npm ci
          npm install -g npm-check-updates
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/test"
          DIRECT_URL: "postgresql://test:test@localhost:5432/test"

      - name: 🔒 Security Audit
        run: |
          npm audit --audit-level high
          npm run check-security

      - name: 📋 Create Security Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '🚨 Security vulnerabilities detected',
              body: 'Automated security scan found vulnerabilities. Run `npm audit` locally for details.',
              labels: ['security', 'priority:high']
            })