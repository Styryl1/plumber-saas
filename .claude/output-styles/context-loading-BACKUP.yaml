# Context Loading Configuration for Plumber SaaS PRP
version: "2.0.0"
strategy: "intelligent_hierarchical"

# Files that are ALWAYS loaded at the start of every session
always_load:
  priority: 1
  files:
    - path: "C:/Users/styry/CLAUDE.md"
      purpose: "Master project context and current status"
      required: true
      fallback: "error"
    
    - path: "C:/Users/styry/plumber-saas/context/prp-active/*.md"
      purpose: "Active PRP patterns and development insights"
      required: false
      fallback: "continue"
    
    - path: "C:/Users/styry/plumber-saas/context/specialists/*.md"
      purpose: "Specialist agent patterns and expertise"
      required: true
      fallback: "error"

# INTELLIGENT CONDITIONAL LOADING BY WORK AREA
conditional_load:
  area_based_loading:
    enabled: true
    exclusivity: true  # Only load relevant area to prevent context pollution
    fallback_to_global: true  # Load global patterns if no area detected
    
  dashboard_context:
    keywords: ["dashboard", "jobs", "customers", "invoices", "scheduling", "calendar", "business", "plumber"]
    priority: 2
    folder_scan: "C:/Users/styry/plumber-saas/dashboard/"
    auto_discover: true
    static_files:  # Always load these if they exist
      - "C:/Users/styry/plumber-saas/dashboard/T3_STACK_ARCHITECTURE.md"
      - "C:/Users/styry/plumber-saas/dashboard/API_PATTERNS.md"
      - "C:/Users/styry/plumber-saas/dashboard/DATABASE_INTEGRATION.md"
      - "C:/Users/styry/plumber-saas/dashboard/SUPABASE_ARCHITECTURE.md"
      - "C:/Users/styry/plumber-saas/dashboard/DATA_MODELS.md"
      - "C:/Users/styry/plumber-saas/dashboard/MULTI_TENANT_PATTERNS.md"
      - "C:/Users/styry/plumber-saas/dashboard/BUSINESS_PARTNER_AI.md"
    dynamic_discovery:  # Auto-find these patterns
      - "*UI*.md"
      - "*UX*.md" 
      - "*COMPONENT*.md"
      - "*PATTERN*.md"
      - "*IMPLEMENTATION*.md"
      - "*GUIDE*.md"
    exclude_areas: ["widget", "ai-core", "marketplace"]  # Don't load these unless explicitly requested
    description: "Complete dashboard implementation patterns: architecture, UI, data, and business logic"
  
  widget_context:
    keywords: ["widget", "chat", "booking", "conversion", "embedding", "iframe"]
    priority: 2
    folder_scan: "C:/Users/styry/plumber-saas/widget/"
    auto_discover: true
    static_files:
      - "C:/Users/styry/plumber-saas/widget/CHAT_PROMPTS.md"
      - "C:/Users/styry/plumber-saas/widget/CONVERSION_OPTIMIZATION.md"
      - "C:/Users/styry/plumber-saas/widget/VISUAL_DESIGN_SYSTEM.md"
    dynamic_discovery:
      - "*WIDGET*.md"
      - "*CHAT*.md"
      - "*CONVERSION*.md"
      - "*EMBEDDING*.md"
      - "*OPTIMIZATION*.md"
    exclude_areas: ["dashboard", "ai-core", "marketplace"]
    description: "Widget embedding, chat optimization, and conversion patterns"
  
  ai_context:
    keywords: ["ai", "gpt", "claude", "prompt", "personality", "voice", "instruction", "model"]
    priority: 2
    folder_scan: "C:/Users/styry/plumber-saas/ai-core/"
    auto_discover: true
    static_files:
      - "C:/Users/styry/plumber-saas/ai-core/AI_INSTRUCTIONS.md"
      - "C:/Users/styry/plumber-saas/ai-core/AI_PERSONALITY_SYSTEM.md"
      - "C:/Users/styry/plumber-saas/ai-core/PROMPT_ENGINEERING_PATTERNS.md"
    dynamic_discovery:
      - "*AI*.md"
      - "*PROMPT*.md"
      - "*PERSONALITY*.md"
      - "*MODEL*.md"
      - "*INSTRUCTION*.md"
    exclude_areas: ["dashboard", "widget", "marketplace"]
    description: "AI personality design, prompt engineering, and instruction patterns"
  
  marketplace_context:
    keywords: ["marketplace", "overflow", "dispatch", "network", "referral"]
    priority: 3
    folder_scan: "C:/Users/styry/plumber-saas/marketplace/"
    auto_discover: true
    static_files:
      - "C:/Users/styry/plumber-saas/marketplace/USER_JOURNEY_MAPS.md"
    dynamic_discovery:
      - "*MARKETPLACE*.md"
      - "*OVERFLOW*.md"
      - "*DISPATCH*.md"
      - "*NETWORK*.md"
      - "*REFERRAL*.md"
    exclude_areas: ["dashboard", "widget", "ai-core"]
    description: "Marketplace integration and overflow management patterns"
  
  technical_context:
    keywords: ["t3", "next", "trpc", "prisma", "supabase", "clerk", "typescript", "architecture", "api"]
    priority: 2
    files:
      - "C:/Users/styry/plumber-saas/dashboard/T3_STACK_ARCHITECTURE.md"
      - "C:/Users/styry/plumber-saas/dashboard/API_PATTERNS.md"
      - "C:/Users/styry/plumber-saas/dashboard/DATABASE_INTEGRATION.md"
      - "C:/Users/styry/plumber-saas/dashboard/SUPABASE_ARCHITECTURE.md"
      - "C:/Users/styry/plumber-saas/dashboard/DATA_MODELS.md"
      - "C:/Users/styry/plumber-saas/dashboard/MULTI_TENANT_PATTERNS.md"
      - "C:/Users/styry/plumber-saas/dashboard/BUSINESS_PARTNER_AI.md"
    description: "Technical architecture, API patterns, and implementation guides"
  
  security_context:
    keywords: ["auth", "permission", "rls", "security", "multi-tenant", "organization"]
    priority: 2
    files:
      - "C:/Users/styry/dashboard/MULTI_TENANT_SECURITY.md"
      - "C:/Users/styry/dashboard/MULTI_TENANT_PATTERNS.md"
    description: "Security patterns and multi-tenant architecture"

# Specialist-specific pattern loading
specialist_patterns:
  ui_specialist:
    trigger_keywords: ["ui", "component", "tailwind", "schedule-x", "mobile", "calendar"]
    files:
      - "C:/Users/styry/plumber-saas/context/specialists/UI_PATTERNS.md"
    mcp_sources:
      context7:
        - "Schedule-X calendar v2 latest features"
        - "shadcn/ui latest components and patterns"
        - "Tailwind CSS 4.0 container queries"
      firecrawl:
        - "https://schedule-x.dev/"
        - "https://ui.shadcn.com/"
  
  ux_design:
    trigger_keywords: ["conversion", "psychology", "journey", "booking", "personality"]
    files:
      - "C:/Users/styry/plumber-saas/context/specialists/ux-design-agent.md"
      - "C:/Users/styry/dashboard/UX_PSYCHOLOGY_PATTERNS.md"
  
  t3_specialist:
    trigger_keywords: ["next", "trpc", "typescript", "react", "prisma"]
    files:
      - "C:/Users/styry/plumber-saas/context/specialists/T3_BEST_PRACTICES.md"
      - "C:/Users/styry/plumber-saas/context/specialists/T3_AI_PATTERNS.md"
    mcp_sources:
      context7:
        - "Next.js 14 App Router latest features"
        - "tRPC v10 latest patterns"
        - "Prisma ORM latest best practices"
  
  database_specialist:
    trigger_keywords: ["supabase", "prisma", "rls", "migration", "postgresql"]
    files:
      - "C:/Users/styry/plumber-saas/context/specialists/DATABASE_PATTERNS.md"
    mcp_sources:
      context7:
        - "Supabase latest features and RLS patterns"
        - "PostgreSQL performance optimization"
  
  auth_specialist:
    trigger_keywords: ["clerk", "auth", "organization", "permission", "user"]
    files:
      - "C:/Users/styry/plumber-saas/context/specialists/AUTH_PATTERNS.md"
    mcp_sources:
      context7:
        - "Clerk latest authentication patterns"
        - "Next.js middleware authentication"
  
  payment_specialist:
    trigger_keywords: ["mollie", "ideal", "payment", "invoice", "btw"]
    files:
      - "C:/Users/styry/plumber-saas/context/specialists/PAYMENT_PATTERNS.md"
    mcp_sources:
      context7:
        - "Mollie API latest features"
        - "Dutch payment regulations"
  
  testing_specialist:
    trigger_keywords: ["test", "validation", "e2e", "browser", "playwright"]
    files:
      - "C:/Users/styry/plumber-saas/context/specialists/TESTING_PATTERNS.md"
    note: "NEVER create test files - use Playwright MCP only"
  
  ai_instruction:
    trigger_keywords: ["gpt", "claude", "prompt", "ai", "chat", "voice"]
    files:
      - "C:/Users/styry/plumber-saas/context/specialists/AI_INSTRUCTION_AGENT.md"

# Context optimization rules
optimization:
  max_context_size: "50000 tokens"
  priority_order:
    1: "always_load files"
    2: "specialist patterns for activated specialists"
    3: "conditional load based on keywords"
    4: "mcp fresh content"
  
  compression_strategy:
    - "Load file summaries if context size exceeded"
    - "Prioritize most recent PRPs and specialist patterns"
    - "Cache MCP responses for session duration"
  
  freshness_requirements:
    specialist_patterns: "24 hours"
    project_context: "immediate"
    mcp_content: "session duration"

# Error handling for context loading
error_handling:
  file_not_found:
    action: "log_warning"
    fallback: "continue_without_file"
    notification: "File missing: {filename}"
  
  permission_denied:
    action: "log_error"
    fallback: "skip_file"
    notification: "Cannot access: {filename}"
  
  context_size_exceeded:
    action: "apply_compression"
    fallback: "load_summaries"
    notification: "Context compressed due to size limits"
  
  mcp_failure:
    action: "use_cached_content"
    fallback: "continue_with_available_context"
    notification: "Using cached MCP content due to connection failure"

# Success validation
validation:
  required_context_loaded:
    - "CLAUDE.md master context"
    - "At least one specialist pattern file"
  
  specialist_activation:
    min_specialists: 1
    max_specialists: 4
    activation_threshold: 0.7
  
  context_completeness:
    check: "All activated specialists have patterns loaded"
    action_if_failed: "Request manual specialist selection"

# Dutch market context specifics
dutch_context:
  always_include:
    terminology:
      - "loodgieter (plumber)"
      - "lekkage (leak)"
      - "spoedgeval (emergency)"
      - "reparatie (repair)"
      - "installatie (installation)"
    
    business_rules:
      - "BTW rates: 21% standard, 9% reduced"
      - "Target cities: Amsterdam → Rotterdam → Utrecht → Den Haag"
      - "iDEAL payment preference"
      - "GDPR compliance requirements"
    
    competitive_advantages:
      - "Netherlands-first development approach"
      - "Local language and cultural optimization"
      - "Dutch business regulation compliance"
      - "Amsterdam market penetration focus"

# Context loading workflow
workflow:
  startup:
    1: "Load always_load files"
    2: "Parse user prompt for keywords"
    3: "Activate specialists based on keyword matching"
    4: "Load conditional context based on keywords"
    5: "Load specialist patterns for activated specialists"
    6: "Fetch fresh MCP content for relevant specialists"
    7: "Validate context completeness"
    8: "Apply Dutch market context"
  
  during_session:
    - "Monitor for new keywords requiring additional context"
    - "Auto-load additional specialist patterns as needed"
    - "Refresh MCP content if patterns become stale"
    - "Update context cache with new learnings"
    - "Auto-detect new .md files in distributed folders"
    - "Update pattern files with implementation progress"
  
  session_end:
    - "Cache successful patterns for future sessions"
    - "Update specialist pattern files with new insights"
    - "Record context loading performance metrics"
    - "Clean up temporary MCP content"
    - "Update distributed documentation with session learnings"

# INTELLIGENT DYNAMIC DISCOVERY SYSTEM
auto_discovery:
  enabled: true
  scan_strategy: "folder_aware_with_intelligent_detection"
  
  work_area_detection:
    method: "analyze_user_prompt_and_file_paths"
    primary_indicators:
      - "File paths mentioned in user prompt"
      - "Keywords indicating specific area (dashboard, widget, ai-core, marketplace)"
      - "Currently edited files directory"
      - "Recently accessed files in session"
    
    area_mapping:
      dashboard:
        folder: "C:/Users/styry/plumber-saas/dashboard/"
        context_scope: ["dashboard", "jobs", "customers", "invoices", "scheduling", "calendar", "business"]
        exclude_from_other_areas: true
        auto_discover_files: true
        
      widget:
        folder: "C:/Users/styry/plumber-saas/widget/"
        context_scope: ["widget", "chat", "booking", "conversion", "embedding", "iframe"]
        exclude_from_other_areas: true
        auto_discover_files: true
        
      ai_core:
        folder: "C:/Users/styry/plumber-saas/ai-core/"
        context_scope: ["ai", "gpt", "claude", "prompt", "personality", "voice", "instruction"]
        exclude_from_other_areas: true
        auto_discover_files: true
        
      marketplace:
        folder: "C:/Users/styry/plumber-saas/marketplace/"
        context_scope: ["marketplace", "overflow", "dispatch", "network", "referral"]
        exclude_from_other_areas: true
        auto_discover_files: true
        
      global:
        folder: "C:/Users/styry/plumber-saas/context/"
        context_scope: ["architecture", "patterns", "global", "system"]
        always_load: true
        auto_discover_files: true

  dynamic_file_discovery:
    scan_frequency: "real_time_when_working_in_area"
    file_patterns:
      - "*.md"
      - "*.mdx"
      - "README*.md"
      - "GUIDE*.md"
      - "*_PATTERNS.md"
      - "*_ARCHITECTURE.md"
      - "*_IMPLEMENTATION.md"
    
    discovery_rules:
      new_files:
        action: "auto_analyze_and_categorize"
        specialist_assignment: "auto_detect_from_content"
        pattern_extraction: "immediate"
        
      modified_files:
        action: "extract_new_patterns"
        update_specialist_knowledge: true
        track_evolution: true
        
      deleted_files:
        action: "remove_from_context_cache"
        update_references: true
        notify_specialists: true

  intelligent_pattern_suggestion:
    enabled: true
    analysis_depth: "deep_content_analysis"
    
    pattern_detection:
      code_examples:
        extract: true
        validate: "syntax_check_and_best_practices"
        categorize: "by_technology_and_use_case"
        
      architectural_decisions:
        track: true
        reasoning_capture: true
        pros_cons_analysis: true
        
      performance_optimizations:
        benchmark: true
        measure_impact: true
        replication_guide: true
        
      dutch_market_patterns:
        cultural_adaptations: true
        compliance_requirements: true
        local_optimizations: true

# LEGACY: Static auto-update patterns (kept for backward compatibility)
static_auto_update_patterns:
  master_context:
    file: "C:/Users/styry/CLAUDE.md"
    triggers: ["project", "vision", "strategy", "rules", "architecture"]
    update_sections:
      - "Current Implementation Status"
      - "Latest Breakthrough"
      - "Immediate Next Priorities"
    specialist_responsible: "all"

# DYNAMIC SPECIALIST ORCHESTRATION FOR FILE UPDATES
specialist_orchestration:
  auto_assignment:
    enabled: true
    assignment_strategy: "content_analysis_with_fallback"
    
    content_analysis:
      method: "keyword_density_and_context_analysis"
      confidence_threshold: 0.75
      
      specialist_content_mapping:
        ui-specialist-agent:
          keywords: ["component", "tailwind", "css", "responsive", "mobile", "calendar", "schedule-x"]
          file_patterns: ["*UI*.md", "*COMPONENT*.md", "*DESIGN*.md", "*STYLE*.md"]
          content_indicators: ["jsx", "tsx", "className", "responsive design", "mobile-first"]
          
        t3-specialist-agent:
          keywords: ["next", "trpc", "typescript", "react", "api", "router", "mutation"]
          file_patterns: ["*T3*.md", "*API*.md", "*ARCHITECTURE*.md", "*ROUTE*.md"]
          content_indicators: ["tRPC", "Next.js", "App Router", "procedure", "middleware"]
          
        database-specialist-agent:
          keywords: ["supabase", "prisma", "rls", "postgresql", "migration", "query"]
          file_patterns: ["*DATABASE*.md", "*SUPABASE*.md", "*MIGRATION*.md", "*RLS*.md"]
          content_indicators: ["schema", "migration", "RLS policy", "PostgreSQL", "Prisma"]
          
        ai-instruction-agent:
          keywords: ["gpt", "claude", "prompt", "ai", "personality", "voice", "chat"]
          file_patterns: ["*AI*.md", "*PROMPT*.md", "*CHAT*.md", "*PERSONALITY*.md"]
          content_indicators: ["prompt engineering", "AI model", "conversation", "personality"]
          
        auth-specialist-agent:
          keywords: ["clerk", "auth", "permission", "organization", "user", "security"]
          file_patterns: ["*AUTH*.md", "*SECURITY*.md", "*PERMISSION*.md", "*USER*.md"]
          content_indicators: ["authentication", "authorization", "middleware", "session"]
          
        payment-specialist-agent:
          keywords: ["mollie", "ideal", "payment", "invoice", "btw", "billing"]
          file_patterns: ["*PAYMENT*.md", "*INVOICE*.md", "*BILLING*.md", "*BTW*.md"]
          content_indicators: ["payment flow", "invoice", "BTW", "Dutch tax", "Mollie"]
          
        ux-design-agent:
          keywords: ["conversion", "psychology", "journey", "booking", "funnel", "optimization"]
          file_patterns: ["*UX*.md", "*CONVERSION*.md", "*JOURNEY*.md", "*PSYCHOLOGY*.md"]
          content_indicators: ["user journey", "conversion rate", "psychology", "behavior"]
          
        testing-specialist-agent:
          keywords: ["test", "validation", "e2e", "playwright", "automation"]
          file_patterns: ["*TEST*.md", "*VALIDATION*.md", "*E2E*.md", "*PLAYWRIGHT*.md"]
          content_indicators: ["test automation", "validation", "browser testing", "E2E"]

    fallback_assignment:
      method: "round_robin_with_expertise_weight"
      consider_current_workload: true
      prefer_recently_active: true

  multi_specialist_coordination:
    enabled: true
    coordination_strategy: "parallel_with_conflict_detection"
    
    parallel_updates:
      max_concurrent: 3
      conflict_detection:
        enabled: true
        overlap_threshold: 0.4  # If 40%+ content overlap, flag conflict
        resolution: "present_options_to_user"
        
    update_synchronization:
      method: "staged_commits"
      stages:
        1: "Individual specialist updates"
        2: "Cross-specialist pattern integration"
        3: "Conflict resolution if needed"
        4: "Final synchronized commit"

# AUTOMATIC FILE UPDATE WORKFLOWS
automatic_file_updates:
  trigger_conditions:
    implementation_success: true
    new_pattern_detected: true
    file_modification_in_work_area: true
    specialist_recommendation: true
    
  update_workflow:
    phase_1_discovery:
      action: "scan_work_area_for_all_md_files"
      scope: "current_work_area_only"  # dashboard ≠ widget
      include_patterns:
        - "*.md"
        - "*.mdx"
        - "README*.md"
        - "*_PATTERNS.md"
        - "*_GUIDE.md"
        - "*_IMPLEMENTATION.md"
        - "*_ARCHITECTURE.md"
      
    phase_2_analysis:
      action: "analyze_each_file_for_update_relevance"
      criteria:
        content_relevance: "keywords_and_context_match"
        recency: "modified_within_session_or_implementation"
        specialist_ownership: "auto_detect_responsible_specialist"
        update_priority: "critical, high, medium, low"
        
    phase_3_specialist_assignment:
      action: "assign_specialists_to_relevant_files"
      assignment_rules:
        primary_specialist: "highest_content_match_confidence"
        secondary_specialists: "if_cross_domain_patterns_detected"
        global_updates: "CLAUDE.md always gets master_context updates"
        
    phase_4_parallel_updates:
      action: "execute_parallel_specialist_updates"
      coordination:
        conflict_prevention: "pre_check_overlapping_sections"
        progress_tracking: "real_time_update_status"
        error_handling: "rollback_if_any_specialist_fails"
        
    phase_5_integration:
      action: "integrate_and_validate_all_updates"
      validation:
        syntax_check: "markdown_and_code_block_validation"
        consistency_check: "cross_file_reference_validation"
        completeness_check: "all_patterns_properly_documented"

# Pattern synchronization rules
pattern_sync:
  frequency: "after_each_implementation"
  method: "intelligent_append_with_deduplication"
  preserve_existing: true
  add_timestamps: true
  deduplication:
    enabled: true
    similarity_threshold: 0.85
    merge_similar_patterns: true
    
  format: |
    ## Updated: {timestamp}
    ### Implementation: {feature_name}
    **Specialist**: {specialist_name}
    **Work Area**: {work_area}
    
    {new_patterns}
    
    **Why this pattern works:**
    {explanation}
    
    **Competitive advantage:**
    {moat_impact}
    
    **Dutch market application:**
    {dutch_specific}
    
    **Cross-references:**
    {related_files_updated}